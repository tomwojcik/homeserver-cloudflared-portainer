version: "3.8"

services:
  ytdl-material:
    image: tzahi12345/youtubedl-material:4.3.2
    container_name: ytdl-material
    restart: always
    network_mode: "container:gluetun"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-UTC}
      - ytdl_mongodb_connection_string=mongodb://ytdl-mongo:27017
      - ytdl_use_local_db=false
      - write_ytdl_config=true
    volumes:
      - /volume1/docker/ytdlp/appdata:/app/appdata
      - /volume1/docker/ytdlp/audio:/app/audio
      - /volume1/docker/ytdlp/video:/app/video
      - /volume1/docker/ytdlp/subscriptions:/app/subscriptions
      - /volume1/docker/ytdlp/users:/app/users
    security_opt:
      - no-new-privileges:true
    user: "1000:1000"
    depends_on:
      - ytdl-mongo
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.2'
          memory: 256M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:17442"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - traefik.enable=true
      - traefik.http.routers.ytdlp.rule=Host(`ytdlp.${SERVER_DOMAIN}`)
      - traefik.http.routers.ytdlp.entrypoints=websecure
      - traefik.http.routers.ytdlp.tls.certresolver=myresolver
      - traefik.http.services.ytdlp.loadbalancer.server.port=17442
      - traefik.docker.network=homeserver

  ytdl-mongo:
    image: mongo:4.4.18
    container_name: ytdl-mongo
    restart: always
    volumes:
      - /volume1/docker/ytdlp/db:/data/db
    networks:
      - homeserver
    security_opt:
      - no-new-privileges:true
    user: "999:999"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    healthcheck:
      test: ["CMD", "mongo", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  homeserver:
    name: homeserver
    external: true